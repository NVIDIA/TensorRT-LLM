

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding a New Model in PyTorch Backend &mdash; tensorrt_llm  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=65e89d2a"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tensorrt_llm
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick-start-guide.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key-features.html">Key Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../torch.html">PyTorch Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/linux.html">Installing on Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/build-from-source-linux.html">Building from Source Code on Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/windows.html">Installing on Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/build-from-source-windows.html">Building from Source Code on Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/grace-hopper.html">Installing on Grace Hopper</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LLM API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../llm-api/index.html">API Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../llm-api/reference.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LLM API Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../llm-api-examples/index.html">LLM Examples Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../llm-api-examples/customization.html">Common Customizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../llm-api-examples/llm_api_examples.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Definition API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python-api/tensorrt_llm.layers.html">Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-api/tensorrt_llm.functional.html">Functionals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-api/tensorrt_llm.models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-api/tensorrt_llm.plugin.html">Plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-api/tensorrt_llm.quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-api/tensorrt_llm.runtime.html">Runtime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C++ API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_cpp_gen/executor.html">Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_cpp_gen/runtime.html">Runtime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Command-Line Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../commands/trtllm-build.html">trtllm-build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/trtllm-serve.html">trtllm-serve</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../architecture/overview.html">TensorRT-LLM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/core-concepts.html">Model Definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/core-concepts.html#compilation">Compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/core-concepts.html#runtime">Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/core-concepts.html#multi-gpu-and-multi-node-support">Multi-GPU and Multi-Node Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/checkpoint.html">TensorRT-LLM Checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/workflow.html">TensorRT-LLM Build Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/add-model.html">Adding a Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced/gpt-attention.html">Multi-Head, Multi-Query, and Group-Query Attention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/gpt-runtime.html">C++ GPT Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/executor.html">Executor API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/graph-rewriting.html">Graph Rewriting Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/inference-request.html">Inference Request</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/inference-request.html#responses">Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/lora.html">Run gpt-2b + LoRA using GptManager / cpp runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/expert-parallelism.html">Expert Parallelism in TensorRT-LLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/kv-cache-reuse.html">KV cache reuse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/speculative-decoding.html">Speculative Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/disaggregated-service.html">Disaggregated-Service (experimental)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/perf-overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/perf-benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance-tuning-guide/index.html">Performance Tuning Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/perf-analysis.html">Performance Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/support-matrix.html">Support Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/precision.html">Numerical Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/memory.html">Memory Usage of TensorRT-LLM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Blogs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../blogs/H100vsA100.html">H100 has 4.6x A100 Performance in TensorRT-LLM, achieving 10,000 tok/s at 100ms to first token</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blogs/H200launch.html">H200 achieves nearly 12,000 tokens/sec on Llama2-13B with TensorRT-LLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blogs/Falcon180B-H200.html">Falcon-180B on a single H200 GPU with INT4 AWQ, and 6.7x faster Llama-70B over A100</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blogs/quantization-in-TRT-LLM.html">Speed up inference with SOTA quantization techniques in TRT-LLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blogs/XQA-kernel.html">New XQA-kernel provides 2.4x more Llama-70B throughput within the same latency budget</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tensorrt_llm</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Adding a New Model in PyTorch Backend</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/torch/adding_new_model.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-a-new-model-in-pytorch-backend">
<h1>Adding a New Model in PyTorch Backend<a class="headerlink" href="#adding-a-new-model-in-pytorch-backend" title="Link to this heading"></a></h1>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#introduction">Introduction</a></p></li>
<li><p><a class="reference internal" href="#prerequisites">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#step-by-step-guide">Step-by-Step Guide</a></p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#model-configuration">Model Configuration</a></p></li>
<li><p><a class="reference internal" href="#model-definition">Model Definition</a></p></li>
<li><p><a class="reference internal" href="#weight-loading">Weight Loading</a></p></li>
<li><p><a class="reference internal" href="#model-registration">Model Registration</a></p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#core-models">Core Models</a></p></li>
<li><p><a class="reference internal" href="#out-of-tree-models">Out-of-Tree Models</a></p></li>
</ol>
</li>
</ol>
</li>
</ol>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>This guide provides a step-by-step process for adding a new model in PyTorch Backend.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h2>
<p>Before you begin, ensure you have the following:</p>
<ul class="simple">
<li><p>A working installation of TensorRT-LLM. Follow these <a class="reference external" href="https://github.com/NVIDIA/TensorRT-LLM/blob/main/docs/source/installation/build-from-source-linux.md">instructions</a>.</p></li>
</ul>
</section>
<section id="step-by-step-guide">
<h2>Step-by-Step Guide<a class="headerlink" href="#step-by-step-guide" title="Link to this heading"></a></h2>
<section id="model-configuration">
<h3>Model Configuration<a class="headerlink" href="#model-configuration" title="Link to this heading"></a></h3>
<p>Suppose you want to support a new model named <code class="docutils literal notranslate"><span class="pre">MyModel</span></code>. If the model is already supported in HuggingFace’s transformers, you should bring the PyTorch modeling code and reuse HuggingFace’s configuration class. For example, our <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/models/modeling_llama.py</span></code> was adapted from HuggingFace’s <a class="reference external" href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/llama/modeling_llama.py">modeling_llama.py</a>; in the modeling code, we reuse the configuration class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">LlamaConfig</span>
</pre></div>
</div>
<p>If the model is not registered in HuggingFace’s transformers, you need to define the configuration class in your <code class="docutils literal notranslate"><span class="pre">configuration_mymodel.py</span></code> following HuggingFace’s <a class="reference external" href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/llama/configuration_llama.py">configuration_llama.py</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers.configuration_utils</span> <span class="kn">import</span> <span class="n">PretrainedConfig</span>

<span class="k">class</span> <span class="nc">MyConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="model-definition">
<h3>Model Definition<a class="headerlink" href="#model-definition" title="Link to this heading"></a></h3>
<p>Remove any unnecessary code (e.g., training-specific code), and then rewrite some PyTorch modules. For a typical Transformer decoder model, you need to implement your <code class="docutils literal notranslate"><span class="pre">modeling_mymodel.py</span></code> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">tensorrt_llm._torch.attention_backend</span> <span class="kn">import</span> <span class="n">AttentionMetadata</span>
<span class="kn">from</span> <span class="nn">tensorrt_llm._torch.model_config</span> <span class="kn">import</span> <span class="n">ModelConfig</span>
<span class="kn">from</span> <span class="nn">tensorrt_llm._torch.models.modeling_utils</span> <span class="kn">import</span> <span class="n">DecoderModel</span><span class="p">,</span> <span class="n">DecoderModelForCausalLM</span>
<span class="kn">from</span> <span class="nn">tensorrt_llm._torch.modules.attention</span> <span class="kn">import</span> <span class="n">Attention</span>
<span class="kn">from</span> <span class="nn">tensorrt_llm._torch.modules.decoder_layer</span> <span class="kn">import</span> <span class="n">DecoderLayer</span>

<span class="kn">from</span> <span class="nn">configuration_mymodel</span> <span class="kn">import</span> <span class="n">MyConfig</span>


<span class="k">class</span> <span class="nc">MyAttention</span><span class="p">(</span><span class="n">Attention</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">],</span> <span class="n">layer_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use model_config to initialize the Attention module</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyDecoderLayer</span><span class="p">(</span><span class="n">DecoderLayer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">],</span> <span class="n">layer_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Use model_config to initialize the submodules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_layernorm</span> <span class="o">=</span> <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">MyAttention</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">layer_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_attention_layernorm</span> <span class="o">=</span> <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">attn_metadata</span><span class="p">:</span> <span class="n">AttentionMetadata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Define the forward computation of a single decoder layer</span>
        <span class="o">...</span>


<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DecoderModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
        <span class="c1"># Use model_config to initialize the submodules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_tokens</span> <span class="o">=</span> <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
            <span class="n">MyDecoderLayer</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">layer_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">pretrained_config</span><span class="o">.</span><span class="n">num_hidden_layers</span><span class="p">)</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">attn_metadata</span><span class="p">:</span> <span class="n">AttentionMetadata</span><span class="p">,</span>
                <span class="n">input_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">inputs_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Define the forward computation of the model</span>
        <span class="o">...</span>


<span class="k">class</span> <span class="nc">MyModelForCausalLM</span><span class="p">(</span><span class="n">DecoderModelForCausalLM</span><span class="p">[</span><span class="n">MyModel</span><span class="p">,</span> <span class="n">MyConfig</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">MyModel</span><span class="p">(</span><span class="n">model_config</span><span class="p">),</span>
                         <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
                         <span class="n">hidden_size</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">pretrained_config</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                         <span class="n">vocab_size</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">pretrained_config</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">MyAttention</span></code> inherits from our <code class="docutils literal notranslate"><span class="pre">Attention</span></code> module (in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/modules/attention.py</span></code>), so that the attention computation is compatible with our PyTorch runtime. Related to this, module inputs should also be adapted:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">attn_metadata</span></code> stores the metadata from the batched input and KV cache for the attention backend. It is created by and passed from the runtime, and model developers need to ensure that <code class="docutils literal notranslate"><span class="pre">attn_metadata</span></code> is correctly passed to the attention module.</p></li>
<li><p>The input tensors (i.e., <code class="docutils literal notranslate"><span class="pre">input_ids</span></code>, <code class="docutils literal notranslate"><span class="pre">position_ids</span></code>, <code class="docutils literal notranslate"><span class="pre">hidden_states</span></code>) are in the packed mode. The first dimension corresponds to the number of tokens in a batch.</p></li>
</ul>
<p>Additionally, <code class="docutils literal notranslate"><span class="pre">MyDecoderLayer</span></code>, <code class="docutils literal notranslate"><span class="pre">MyModel</span></code>, and <code class="docutils literal notranslate"><span class="pre">MyModelForCausalLM</span></code> are subclasses of <code class="docutils literal notranslate"><span class="pre">DecoderLayer</span></code>, <code class="docutils literal notranslate"><span class="pre">DecoderModel</span></code>, and <code class="docutils literal notranslate"><span class="pre">DecoderModelForCausalLM</span></code> respectively. The base classes define interfaces and provide a generic scaffolding to define model layers, load weights, etc.</p>
<p>Optionally, you may replace the native PyTorch modules with our implementations to enable features or achieve higher performance:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Linear</span></code> (in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/modules/linear.py</span></code>): Enables tensor parallelism and quantization.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Embedding</span></code> (in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/modules/embedding.py</span></code>): Enables tensor parallelism for embedding.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RotaryEmbedding</span></code> (in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/modules/rotary_embedding.py</span></code>): Enables performant rotary embedding.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RMSNorm</span></code> (in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/modules/rms_norm.py</span></code>): Enables performant RMS norm.</p></li>
</ul>
<p>For a concrete reference, check out <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/models/modeling_llama.py</span></code>.</p>
</section>
<section id="weight-loading">
<h3>Weight Loading<a class="headerlink" href="#weight-loading" title="Link to this heading"></a></h3>
<p>The base class <code class="docutils literal notranslate"><span class="pre">DecoderModelForCausalLM</span></code> provides a <code class="docutils literal notranslate"><span class="pre">load_weights</span></code> method that loads the weights from the checkpoint file and assigns them to the corresponding layers in the model. However, if the default method does not work for <code class="docutils literal notranslate"><span class="pre">MyModelForCausalLM</span></code>, you need to implement your own <code class="docutils literal notranslate"><span class="pre">load_weights</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModelForCausalLM</span><span class="p">(</span><span class="n">DecoderModelForCausalLM</span><span class="p">[</span><span class="n">MyModel</span><span class="p">,</span> <span class="n">MyConfig</span><span class="p">]):</span>

    <span class="k">def</span> <span class="nf">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># Define the weight loading logic</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>For example, Huggingface’s LLaMA model uses three linear layers for Q/K/V projections, resulting in three weight tensors in the checkpoint:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">weights</span>
<span class="go">{</span>
<span class="go">    ...,</span>
<span class="go">    &quot;model.layers.0.self_attn.q_proj.weight&quot;: torch.Tensor([hidden_size, hidden_size]),</span>
<span class="go">    &quot;model.layers.0.self_attn.k_proj.weight&quot;: torch.Tensor([hidden_size, hidden_size]),</span>
<span class="go">    &quot;model.layers.0.self_attn.v_proj.weight&quot;: torch.Tensor([hidden_size, hidden_size]),</span>
<span class="go">    ...,</span>
<span class="go">}</span>
</pre></div>
</div>
<p>However, our LLaMA model fuses the three layers into one linear layer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">llama</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">qkv_proj</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span>
<span class="go">torch.Tensor([hidden_size * 3, hidden_size])</span>
</pre></div>
</div>
<p>Hence, <code class="docutils literal notranslate"><span class="pre">load_weights</span></code> needs to collect the three weight tensors from the original checkpoint, concatenate them, and assign them to the fused linear layer. Considering tensor parallelism and quantization, the process would be more complicated. We recommend calling the predefined module-level <code class="docutils literal notranslate"><span class="pre">load_weights</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">Linear</span></code> and <code class="docutils literal notranslate"><span class="pre">Embedding</span></code>) when implementing your model-level <code class="docutils literal notranslate"><span class="pre">load_weights</span></code> method.</p>
<p>Overall, <code class="docutils literal notranslate"><span class="pre">load_weights</span></code> should handle any discrepancy between <code class="docutils literal notranslate"><span class="pre">MyModelForCausalLM</span></code> and the weights loaded from the checkpoint, so that <code class="docutils literal notranslate"><span class="pre">MyModelForCausalLM</span></code> can perform forward computation equivalent to the original model.</p>
</section>
<section id="model-registration">
<h3>Model Registration<a class="headerlink" href="#model-registration" title="Link to this heading"></a></h3>
<p>The new model needs to be registered so that it can be recognized by the PyTorch runtime. The registration can be done simply by adding the <code class="docutils literal notranslate"><span class="pre">register_auto_model</span></code> decorator for <code class="docutils literal notranslate"><span class="pre">MyModelForCausalLM</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorrt_llm._torch.models.modeling_utils</span> <span class="kn">import</span> <span class="n">register_auto_model</span>

<span class="nd">@register_auto_model</span><span class="p">(</span><span class="s2">&quot;MyModelForCausalLM&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyModelForCausalLM</span><span class="p">(</span><span class="n">DecoderModelForCausalLM</span><span class="p">[</span><span class="n">MyModel</span><span class="p">,</span> <span class="n">MyConfig</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">]):</span>
       <span class="o">...</span>
</pre></div>
</div>
<section id="core-models">
<h4>Core Models<a class="headerlink" href="#core-models" title="Link to this heading"></a></h4>
<p>To add the new model to core models, <code class="docutils literal notranslate"><span class="pre">modeling_mymodel.py</span></code> (and potentially <code class="docutils literal notranslate"><span class="pre">configuration_mymodel.py</span></code>) should be placed in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/models</span></code>. Then, you need to import the modeling code in <code class="docutils literal notranslate"><span class="pre">tensorrt_llm/_torch/models/__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.modeling_mymodel</span> <span class="kn">import</span> <span class="n">MyModelForCausalLM</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="s2">&quot;MyModelForCausalLM&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="out-of-tree-models">
<h4>Out-of-Tree Models<a class="headerlink" href="#out-of-tree-models" title="Link to this heading"></a></h4>
<p>Alternatively, you can register the new model as an out-of-tree model, so that you can use the new model without touching the TensorRT-LLM codebase. To do so, place <code class="docutils literal notranslate"><span class="pre">modeling_mymodel.py</span></code> (and potentially <code class="docutils literal notranslate"><span class="pre">configuration_mymodel.py</span></code>) in your working directory, and import the modeling code in your script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorrt_llm._torch</span> <span class="kn">import</span> <span class="n">LLM</span>
<span class="kn">import</span> <span class="nn">modeling_mymodel</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="n">LLM</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>We provide an out-of-tree modeling example in <code class="docutils literal notranslate"><span class="pre">examples/pytorch/out_of_tree_example</span></code>. The model is implemented in <code class="docutils literal notranslate"><span class="pre">modeling_opt.py</span></code> and you can run the example by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>examples/pytorch/out_of_tree_example/main.py
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
<jinja2.runtime.BlockReference object at 0x7fdeec6698e0>

<div class="footer">
    <p>
        Copyright © 2024 NVIDIA Corporation
    </p>
    <p>
        <a class="Link" href="https://www.nvidia.com/en-us/about-nvidia/privacy-policy/" target="_blank" rel="noopener"
            data-cms-ai="0">Privacy Policy</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/about-nvidia/privacy-center/" target="_blank" rel="noopener"
            data-cms-ai="0">Manage My Privacy</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/preferences/start/" target="_blank" rel="noopener"
            data-cms-ai="0">Do Not Sell or Share My Data</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/about-nvidia/terms-of-service/" target="_blank"
            rel="noopener" data-cms-ai="0">Terms of Service</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/about-nvidia/accessibility/" target="_blank" rel="noopener"
            data-cms-ai="0">Accessibility</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/about-nvidia/company-policies/" target="_blank"
            rel="noopener" data-cms-ai="0">Corporate Policies</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/product-security/" target="_blank" rel="noopener"
            data-cms-ai="0">Product Security</a> |
        <a class="Link" href="https://www.nvidia.com/en-us/contact/" target="_blank" rel="noopener"
            data-cms-ai="0">Contact</a>
    </p>
</div>


  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>